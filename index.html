<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Consulta con Filtros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        th, td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
        }
        th:hover {
            background-color: #e2e8f0;
        }
        .sort-icon {
            margin-left: 5px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl"> 
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Sistema de Consulta Integrado</h1>

        <!-- Sección de selección de establecimiento -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Selección de Establecimiento</h2>
            
            <div class="flex flex-wrap gap-4 mb-4">
                <div class="flex-1 min-w-[250px]">
                    <label for="oficina" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Establecimiento</label>
                    <select id="oficina" onchange="cargarServicios()" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base">
                        <option value="">Seleccione un tipo</option>
                        <option value="DIRIS">ESTABLECIMIENTOS DE SALUD</option>
                        <option value="CS">FARMAMINSA</option>
                    </select>
                </div>

                <div class="flex-1 min-w-[250px]">
                    <label for="inputServicio" class="block text-sm font-medium text-gray-700 mb-1">Establecimiento</label>
                    <input type="text" id="inputServicio" placeholder="Escriba para buscar..." list="listaServicios" autocomplete="off" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base">
                    <datalist id="listaServicios"></datalist>
                </div>
            </div>
        </div>

        <!-- Sección de consulta de datos -->
        <div class="mb-6 p-6 bg-gray-50 rounded-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Consulta de Datos</h2>
            
            <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="fetchDataBtn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Consultar Datos
                </button>
            </div>
        </div>

        <!-- Filtros para la tabla -->
        <div id="filtersContainer" class="hidden mb-4 p-4 bg-blue-50 rounded-lg">
            <h3 class="text-lg font-medium text-gray-700 mb-2">Filtrar por Stock</h3>
            <div class="flex flex-wrap gap-4">
                <button onclick="sortTable('asc')" class="px-4 py-2 bg-white border border-blue-500 text-blue-500 rounded-md hover:bg-blue-50">
                    Menor a Mayor Stock
                </button>
                <button onclick="sortTable('desc')" class="px-4 py-2 bg-white border border-blue-500 text-blue-500 rounded-md hover:bg-blue-50">
                    Mayor a Menor Stock
                </button>
                <button onclick="filterZeroStock()" class="px-4 py-2 bg-white border border-red-500 text-red-500 rounded-md hover:bg-red-50">
                    Mostrar Solo Stock Cero
                </button>
                <button onclick="resetFilters()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                    Resetear Filtros
                </button>
            </div>
        </div>

        <!-- Indicador de carga -->
        <div id="loadingIndicator" class="text-center text-blue-600 text-lg font-medium hidden mb-4">
            Cargando datos...
        </div>

        <!-- Resultados -->
        <div id="results" class="mt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Resultados:</h2>
            <div id="tableContainer" class="overflow-x-auto">
                <p id="dataMessage" class="text-gray-600">Seleccione un establecimiento y haga clic en "Consultar Datos".</p>
            </div>
        </div>
    </div>

    <script>
        // Datos de establecimientos
        const servicios = {
            DIRIS: ["C.S CATALINA HUANCA", "C.S.M.C DAVID TEJADA"],
            CS: ["FARMAMINSA-EL AGUSTINO", "FARMAMINSA-ATE", "FARMAMINSA-CHOSICA"]
        };

        // Mapeo de establecimientos a IDs de hojas
        const establecimientoIds = {
            "FARMAMINSA-EL AGUSTINO": "1",
            "FARMAMINSA-CHOSICA": "2",
            "FARMAMINSA-ATE": "farma"
        };

        // Variables globales
        let currentData = [];
        let headers = [];

        // Elementos del DOM
        const tableContainer = document.getElementById('tableContainer');
        const dataMessage = document.getElementById('dataMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const fetchDataBtn = document.getElementById('fetchDataBtn');
        const filtersContainer = document.getElementById('filtersContainer');

        const API_BASE_URL = 'https://api-consulta-sismed.googlesites.cloud';

        // Cargar servicios según tipo de establecimiento seleccionado
        function cargarServicios() {
            const oficina = document.getElementById("oficina").value;
            const inputServicio = document.getElementById("inputServicio");
            const datalist = document.getElementById("listaServicios");

            inputServicio.value = "";
            datalist.innerHTML = "";

            if (servicios[oficina]) {
                servicios[oficina].forEach(area => {
                    const option = document.createElement("option");
                    option.value = area;
                    datalist.appendChild(option);
                });
            }
        }

        // Consultar datos de la API
        async function fetchData() {
            const establecimiento = document.getElementById('inputServicio').value;
            
            if (!establecimiento) {
                alert("¡Por favor seleccione un establecimiento válido!");
                return;
            }
            
            const selectedId = establecimientoIds[establecimiento];
            if (!selectedId) {
                alert("No se encontró el ID de hoja para este establecimiento");
                return;
            }

            const apiUrl = `${API_BASE_URL}/leer-sheet?id=${selectedId}`;

            tableContainer.innerHTML = '';
            dataMessage.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            filtersContainer.classList.add('hidden');

            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status} - ${errorData.message}`);
                }

                const data = await response.json();

                if (data.valores && data.valores.length > 0) {
                    headers = data.valores[0];
                    currentData = data.valores.slice(1);
                    
                    renderTable(headers, currentData);
                    filtersContainer.classList.remove('hidden');
                } else {
                    dataMessage.textContent = 'No se encontraron datos o la estructura no es la esperada.';
                    dataMessage.classList.remove('hidden');
                }

            } catch (error) {
                dataMessage.textContent = `Error al obtener los datos: \n${error.message}`;
                dataMessage.classList.remove('hidden');
                console.error('Error fetching data:', error);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Renderizar la tabla
        function renderTable(headers, data) {
            tableContainer.innerHTML = '';
            
            const table = document.createElement('table');
            table.classList.add('min-w-full', 'bg-white', 'shadow-md', 'rounded-lg', 'overflow-hidden');
            
            // Crear encabezado de tabla
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            headers.forEach((headerText, index) => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.classList.add('py-2', 'px-3', 'border-b', 'border-gray-200', 'bg-gray-50', 'text-sm', 'font-semibold', 'text-gray-600', 'uppercase', 'tracking-wider');
                
                // Hacer que la columna STOCK sea ordenable
                if (headerText === 'STOCK') {
                    th.innerHTML += '<span class="sort-icon">↓↑</span>';
                    th.onclick = () => toggleSortStock();
                }
                
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Crear cuerpo de tabla
            const tbody = document.createElement('tbody');
            
            data.forEach(rowData => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-50');
                
                rowData.forEach((cellData, cellIndex) => {
                    const td = document.createElement('td');
                    td.textContent = cellData;
                    td.classList.add('py-2', 'px-3', 'border-b', 'border-gray-200', 'text-sm', 'text-gray-800');
                    
                    // Resaltar stock cero en rojo
                    if (headers[cellIndex] === 'STOCK' && cellData === '0') {
                        td.classList.add('text-red-500', 'font-medium');
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            tableContainer.appendChild(table);
        }

        // Funciones de filtrado
        let sortDirection = null;

        function toggleSortStock() {
            if (sortDirection === 'desc') {
                sortTable('asc');
                sortDirection = 'asc';
            } else {
                sortTable('desc');
                sortDirection = 'desc';
            }
        }

        function sortTable(direction) {
            if (!headers.includes('STOCK')) return;
            
            const stockIndex = headers.indexOf('STOCK');
            const sortedData = [...currentData];
            
            sortedData.sort((a, b) => {
                const stockA = parseInt(a[stockIndex]) || 0;
                const stockB = parseInt(b[stockIndex]) || 0;
                
                return direction === 'asc' ? stockA - stockB : stockB - stockA;
            });
            
            renderTable(headers, sortedData);
        }

        function filterZeroStock() {
            if (!headers.includes('STOCK')) return;
            
            const stockIndex = headers.indexOf('STOCK');
            const filteredData = currentData.filter(row => {
                const stock = parseInt(row[stockIndex]) || 0;
                return stock === 0;
            });
            
            renderTable(headers, filteredData);
        }

        function resetFilters() {
            renderTable(headers, currentData);
            sortDirection = null;
        }

        // Event listeners
        fetchDataBtn.addEventListener('click', fetchData);
    </script>
</body>
</html>