<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta SISMID</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    th, td {
      word-wrap: break-word;
      white-space: normal;
    }
  </style>
</head>
<body class="bg-gray-50 text-sm text-gray-800 p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-lg font-bold mb-4 text-center">Consulta Inventario SISMID</h1>

    <div class="mb-4">
      <label for="establecimientos" class="block font-medium mb-1">Establecimiento</label>
      <input list="establecimientos" id="inputServicio" class="w-full border p-2 rounded" placeholder="Buscar establecimiento...">
      <datalist id="establecimientos"></datalist>
    </div>

    <div class="mb-4">
      <label for="oficina" class="block font-medium mb-1">Tipo de Establecimiento</label>
      <select id="oficina" class="w-full border p-2 rounded">
        <option value="1">Red</option>
        <option value="2">Microred</option>
        <option value="farma">FARMAMINSA ATE</option>
      </select>
    </div>

    <button id="fetchDataBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Consultar</button>

    <div id="loading" class="mt-4 hidden">
      <p class="text-blue-600">Cargando datos...</p>
    </div>

    <div id="result" class="mt-6 overflow-x-auto"></div>
  </div>

  <script>
    const apiBase = "https://sismed-api.deta.dev";

    const elements = {
      inputServicio: document.getElementById("inputServicio"),
      oficina: document.getElementById("oficina"),
      fetchDataBtn: document.getElementById("fetchDataBtn"),
      result: document.getElementById("result"),
      loading: document.getElementById("loading"),
      establecimientos: document.getElementById("establecimientos")
    };

    const renderTable = (data) => {
      const table = document.createElement("table");
      table.className = "min-w-full table-auto border border-gray-300 shadow text-xs";

      const thead = document.createElement("thead");
      thead.className = "bg-gray-200";

      const tbody = document.createElement("tbody");

      data.forEach((row, rowIndex) => {
        const tr = document.createElement("tr");

        row.forEach((cell, colIndex) => {
          const cellElement = document.createElement(rowIndex === 0 ? "th" : "td");
          cellElement.textContent = cell;

          if (rowIndex === 0) {
            cellElement.className = "px-2 py-2 border font-bold";
            if (cell === "STOCK") {
              cellElement.classList.add("cursor-pointer", "text-blue-700");
              cellElement.onclick = () => sortTableByStock(data);
            }
            if (cell === "FECHA_STOCK") {
              cellElement.classList.add("cursor-pointer", "text-blue-700");
              cellElement.onclick = () => sortTableByDate(data);
            }
          } else {
            cellElement.className = "px-2 py-2 border text-[11px] whitespace-normal break-words";
          }

          tr.appendChild(cellElement);
        });

        if (rowIndex === 0) {
          thead.appendChild(tr);
        } else {
          tbody.appendChild(tr);
        }
      });

      table.appendChild(thead);
      table.appendChild(tbody);

      elements.result.innerHTML = "";
      elements.result.appendChild(table);
    };

    const sortTableByStock = (data) => {
      const headers = data[0];
      const stockIndex = headers.indexOf("STOCK");

      const sorted = [...data.slice(1)].sort((a, b) => {
        const aVal = parseFloat(a[stockIndex]) || 0;
        const bVal = parseFloat(b[stockIndex]) || 0;
        return bVal - aVal;
      });

      renderTable([headers, ...sorted]);
    };

    const sortTableByDate = (data) => {
      const headers = data[0];
      const dateIndex = headers.indexOf("FECHA_STOCK");

      const sorted = [...data.slice(1)].sort((a, b) => {
        const aDate = new Date(a[dateIndex]);
        const bDate = new Date(b[dateIndex]);
        return bDate - aDate;
      });

      renderTable([headers, ...sorted]);
    };

    const fetchData = async () => {
      const establecimiento = elements.inputServicio.value.trim();
      const oficina = elements.oficina.value;

      if (!establecimiento) {
        alert("Por favor seleccione un establecimiento vÃ¡lido.");
        return;
      }

      elements.loading.classList.remove("hidden");
      elements.result.innerHTML = "";

      try {
        const url = `${apiBase}/leer-sheet?id=${oficina}`;
        const response = await fetch(url);
        const json = await response.json();

        if (json && json.valores && Array.isArray(json.valores)) {
          const valoresFiltrados = json.valores.filter((row, i) => {
            if (i === 0) return true; // encabezado
            return row[0].toLowerCase().includes(establecimiento.toLowerCase());
          });

          if (valoresFiltrados.length > 1) {
            renderTable(valoresFiltrados);
          } else {
            elements.result.innerHTML = "<p class='text-red-600'>No se encontraron resultados.</p>";
          }
        } else {
          elements.result.innerHTML = "<p class='text-red-600'>Error al procesar datos.</p>";
        }
      } catch (err) {
        console.error("Error al consultar API:", err);
        elements.result.innerHTML = "<p class='text-red-600'>Error al consultar la API.</p>";
      } finally {
        elements.loading.classList.add("hidden");
      }
    };

    const cargarEstablecimientos = async () => {
      const oficina = elements.oficina.value;
      try {
        const url = `${apiBase}/leer-sheet?id=${oficina}`;
        const response = await fetch(url);
        const json = await response.json();

        if (json && json.valores && Array.isArray(json.valores)) {
          const nombres = Array.from(new Set(json.valores.slice(1).map(row => row[0])));
          elements.establecimientos.innerHTML = nombres.map(nombre => `<option value="${nombre}">`).join("");
        }
      } catch (err) {
        console.error("Error cargando establecimientos:", err);
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      cargarEstablecimientos();
      elements.oficina.addEventListener("change", cargarEstablecimientos);
      elements.fetchDataBtn.addEventListener("click", fetchData);
    });
  </script>
</body>
</html>
